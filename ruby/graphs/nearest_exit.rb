# https://leetcode.com/problems/nearest-exit-from-entrance-in-maze/

require 'set'

# @param {Character[][]} maze
# @param {Integer[]} entrance
# @return {Integer}
def nearest_exit(maze, entrance)
  dijkstra(maze, entrance)
end

def dijkstra(maze, entrance)
  height = maze.size
  width = maze[0].size
  queue = build_queue(maze)
  distances = build_distances(maze, queue, entrance)
  candidates = Set.new
  exits = Set.new

  current = entrance
  while queue.any? && current
    # p [current, queue, candidates]
    queue.delete(current)
    candidates.delete(current)
    list = neighbours(current, queue)
    list.each do |pos|
      if queue.include?(pos)
        candidates.add(pos)
        min = [distances[current] + 1, distances[pos]].min
        distances[pos] = min
        if exit?(pos, entrance, width, height)
          exits.add(pos)
          return 1 if min == 1
        end
      end
    end
    current = next_candidate(candidates, distances)
  end

  shortest_path = Float::INFINITY
  exits.each do |pos|
    shortest_path = [distances[pos], shortest_path].min
  end
  shortest_path == Float::INFINITY ? -1 : shortest_path
end

def next_candidate(candidates, distances)
  pos = nil
  min = Float::INFINITY
  current = nil
  candidates.each do |pos|
    distance = distances[pos]
    if distance < min
      current = pos
      min = distance
    end
  end
  current
end

def neighbours(pos, queue)
  dirs = { u: [-1, 0], r: [0, 1], d: [1, 0], l: [0, -1]}
  i, j = pos
  result = []
  dirs.each do |_, dir|
    neighbour = [i + dir[0], j + dir[1]]
    result << neighbour if queue.include?(neighbour)
  end
  result
end

# its on border and is not the entrance
def exit?(pos, entrance, width, height)
  (pos[0] == 0 || pos[1] == 0 || pos[0] == (height - 1) || pos[1] == (width - 1)) && pos != entrance
end

def build_queue(maze)
  queue = Set.new
  maze.each_with_index do |row, j|
    row.each_with_index do |val, i|
      queue << [j, i] if val == '.'
    end
  end
  queue
end

def build_distances(maze, queue, entrance)
  distances = queue.map{|pos| [pos, Float::INFINITY]}.to_h
  distances[entrance] = 0
  distances
end

maze = [["+","+",".","+"],[".",".",".","+"],["+","+","+","."]]
entrance = [1,2]
p nearest_exit(maze, entrance)

maze = [["+","+","+"],[".",".","."],["+","+","+"]]
entrance = [1,0]
p nearest_exit(maze, entrance)

maze = [[".","+"]]
entrance = [0,0]
p nearest_exit(maze, entrance)

maze = [[".","+",".","+","+",".",".","+",".",".",".",".",".","+","+","+",".","+",".",".",".",".",".",".",".",".",".","+","+",".",".","+",".",".",".",".",".",".",".",".",".","+"],["+",".",".",".","+",".",".",".","+",".","+",".","+",".",".","+",".","+",".",".","+",".",".","+",".",".","+",".",".","+",".","+",".",".",".",".",".",".","+","+","+","."],[".",".",".","+",".","+",".",".","+",".",".","+",".",".",".","+",".",".",".",".",".",".",".",".",".",".",".","+",".","+",".",".",".",".",".",".",".",".","+",".",".","+"],[".",".",".","+","+","+",".",".",".","+",".","+",".",".",".",".","+","+",".","+",".","+",".",".",".",".",".",".","+","+",".",".",".","+",".",".",".","+","+",".","+","."],[".",".",".",".","+",".",".",".",".","+",".",".",".",".",".",".",".","+","+",".",".",".","+",".",".","+",".",".","+",".",".",".",".",".",".","+",".","+",".",".",".","+"],[".",".",".",".",".",".",".",".",".",".",".","+",".",".",".",".",".",".","+",".",".",".","+",".","+","+",".",".",".",".",".",".","+",".","+",".",".",".",".",".",".","."],[".",".","+",".","+",".","+",".","+","+",".",".",".",".","+",".",".","+","+","+",".",".",".","+","+","+","+",".","+",".",".",".",".",".",".",".",".",".",".",".",".","."],[".",".","+",".",".","+",".",".","+",".",".","+","+","+","+",".",".","+",".",".","+","+",".",".",".",".",".",".",".","+",".",".","+",".",".","+",".",".",".",".",".","."],["+",".",".",".",".",".","+",".","+",".","+",".","+",".","+",".","+","+",".",".",".",".","+",".",".","+","+",".",".","+",".",".",".","+",".","+","+",".",".",".","+","."],[".",".",".",".",".",".",".",".",".","+",".",".",".",".","+",".",".",".","+",".","+",".",".",".",".","+","+",".",".","+",".",".",".","+","+",".",".",".",".",".",".","."],[".",".","+",".",".",".","+",".",".","+",".",".","+",".","+",".",".",".",".",".",".","+",".",".",".","+",".","+","+","+",".",".",".","+",".",".",".",".",".",".","+","+"],[".","+",".",".",".","+",".",".",".",".","+",".",".",".","+","+",".",".",".",".",".",".","+",".",".",".","+",".",".","+","+","+","+",".","+","+",".",".",".",".",".","+"],["+","+","+","+",".",".","+",".",".","+",".",".",".","+",".","+","+",".","+","+","+",".",".",".",".",".","+",".",".","+",".",".",".",".",".",".",".",".","+","+",".","."],[".",".",".",".",".","+",".",".",".",".",".",".",".",".","+",".",".",".",".",".",".",".",".","+","+","+",".",".","+",".",".",".","+",".",".",".","+","+",".","+","+","."],[".",".",".",".",".","+",".",".",".",".",".",".","+","+",".","+",".","+","+","+",".",".","+",".","+",".",".",".",".",".",".","+",".",".","+",".",".",".",".",".",".","+"],[".",".",".",".",".","+",".",".","+",".",".",".",".","+",".",".",".",".",".",".",".",".",".","+",".",".","+",".",".","+","+",".",".","+","+",".",".",".",".","+",".","."],[".",".",".",".","+",".","+",".",".",".","+",".",".",".","+",".",".",".","+",".",".",".",".",".",".",".",".",".","+",".",".","+",".",".",".",".",".",".",".",".",".","."],["+","+",".",".",".",".",".",".",".",".",".",".",".",".",".","+",".",".",".",".",".",".","+","+",".",".",".",".",".","+",".","+",".",".",".","+","+",".",".","+","+","+"],[".",".","+",".","+","+","+",".",".",".",".",".","+","+","+","+","+",".","+",".",".","+",".",".","+",".",".",".",".",".",".",".","+",".","+",".",".","+","+",".","+","."],[".","+","+",".","+",".",".","+",".",".","+",".","+",".",".","+",".",".","+","+","+",".","+",".",".",".","+",".",".",".",".",".",".","+",".","+","+","+",".","+",".","."],["+",".",".","+",".",".",".",".",".","+",".","+",".","+",".",".",".",".",".",".",".",".","+",".","+","+",".",".","+",".",".","+",".",".",".",".","+","+",".",".",".","+"],["+",".",".",".",".",".",".",".","+","+",".",".",".",".","+","+","+","+","+","+","+","+","+",".",".",".",".",".","+",".",".",".",".",".",".",".","+","+",".",".",".","."],[".","+",".",".",".",".",".","+",".",".","+","+",".",".",".",".",".",".",".","+","+",".",".",".",".",".",".",".","+",".",".",".",".",".",".",".",".",".",".",".","+","."],[".",".",".","+","+",".",".","+",".",".",".",".","+",".",".","+",".","+","+","+","+",".","+","+",".",".",".","+","+",".","+",".",".",".",".",".","+","+",".","+","+","."],[".",".",".","+",".",".","+",".",".","+",".",".",".",".",".",".",".","+",".",".",".","+","+",".",".","+",".",".","+",".","+","+",".",".",".",".","+","+","+","+","+","."],["+",".",".",".",".",".",".",".",".",".",".",".",".","+",".",".",".",".","+",".",".",".","+","+",".","+",".","+",".",".",".","+","+",".","+","+","+",".",".",".","+","+"],["+",".",".",".","+","+",".",".",".","+",".","+",".",".",".","+","+",".",".","+",".",".",".",".",".",".","+",".",".",".","+","+","+",".",".",".",".","+",".",".",".","."],[".","+",".",".",".",".",".","+","+",".",".","+",".","+",".",".",".",".",".",".",".",".","+","+",".",".","+",".",".",".",".",".",".","+","+","+",".","+",".",".","+","+"],[".",".",".",".",".","+",".",".",".",".","+","+","+",".","+",".",".","+",".",".",".","+","+",".","+","+",".",".",".",".",".",".",".",".",".",".","+",".",".",".",".","+"],[".","+",".",".","+",".",".","+",".",".",".",".",".",".","+",".","+","+",".","+",".",".",".","+","+",".","+",".",".",".",".",".",".","+",".","+","+",".",".",".",".","."],[".",".",".",".",".","+",".",".","+",".",".","+","+",".","+",".",".","+",".",".",".",".",".","+",".",".","+",".",".","+","+",".",".",".",".",".",".",".",".",".",".","."],["+","+",".",".","+",".","+",".",".",".",".","+",".",".","+",".",".",".",".",".",".",".","+",".","+",".","+","+","+","+",".","+",".","+","+",".","+",".","+",".","+","."],["+",".",".","+",".","+",".",".",".",".",".",".",".","+","+",".",".","+","+",".",".",".",".","+",".",".","+",".",".",".",".","+",".",".","+",".","+",".",".","+",".","+"],["+",".",".",".",".",".","+","+",".","+",".",".",".",".",".","+",".",".",".",".",".","+","+",".",".",".",".",".",".","+",".","+","+",".",".",".","+","+",".",".",".","."],[".",".","+",".",".","+","+",".","+","+",".",".",".",".",".",".",".",".",".",".",".",".",".",".",".","+",".","+","+","+",".",".",".","+",".",".","+",".",".",".",".","+"],[".",".","+",".",".",".",".",".","+",".","+","+","+",".",".","+",".",".",".",".",".",".",".",".","+",".",".","+",".","+",".","+",".",".",".","+",".",".",".",".","+","."],[".",".",".","+",".","+",".","+",".","+",".",".","+","+","+","+",".",".",".","+",".","+","+","+","+","+",".",".",".","+",".",".",".",".","+","+",".",".",".",".","+","."],[".",".",".","+",".","+",".",".",".","+",".",".","+","+",".",".","+",".",".","+",".",".",".",".","+",".","+",".","+",".",".",".",".",".","+","+",".",".","+",".","+","+"],["+",".","+",".",".",".","+",".","+",".","+",".",".",".",".","+",".","+",".",".",".","+",".",".",".",".","+",".","+",".",".",".",".",".",".",".",".",".",".",".",".","+"],["+",".",".",".","+",".",".",".",".",".","+","+","+",".",".",".","+",".","+","+",".","+",".",".","+",".","+","+",".",".",".",".",".",".",".","+",".","+",".",".",".","."],["+",".",".",".",".",".",".",".","+",".",".",".","+","+",".","+",".",".",".",".",".","+",".",".","+",".",".",".",".",".",".","+",".",".",".",".",".",".",".",".",".","."],[".",".","+","+",".",".",".",".",".",".",".","+","+",".",".","+",".","+",".","+",".",".",".","+",".","+",".",".","+",".",".",".",".","+",".",".",".","+",".",".","+","."],[".",".",".","+","+",".",".",".",".","+",".","+",".",".",".",".",".",".",".",".",".",".","+",".",".",".",".",".",".",".","+",".",".",".","+",".",".",".",".","+",".","."],[".",".",".","+",".",".",".",".",".",".",".",".","+","+",".","+",".",".",".",".","+",".","+",".",".",".",".",".","+","+","+","+",".","+","+",".",".",".",".",".",".","."],["+",".",".",".",".",".",".","+",".",".",".",".","+",".","+",".",".",".",".","+",".","+",".",".",".","+","+",".",".","+",".",".",".","+",".",".",".","+",".",".","+","+"],[".",".","+",".","+","+","+",".",".",".",".",".",".",".",".",".","+","+",".",".",".",".",".","+","+",".","+",".","+",".",".",".",".",".",".",".",".",".",".","+",".","."],[".","+","+",".","+",".",".",".",".",".",".",".",".","+",".","+","+",".",".",".",".",".","+",".","+",".",".","+","+",".",".",".","+","+","+",".",".",".",".",".",".","+"],[".","+",".","+","+",".","+",".",".","+","+","+",".","+",".","+",".",".",".","+","+","+",".",".","+",".",".","+",".","+",".",".","+",".","+",".","+","+",".",".","+","."],[".",".",".","+",".","+","+",".",".",".",".",".",".",".",".","+",".",".","+","+","+",".",".","+",".",".",".",".",".",".","+",".","+",".","+",".",".",".",".",".",".","."]]
entrance = [48,41]
p nearest_exit(maze, entrance)
